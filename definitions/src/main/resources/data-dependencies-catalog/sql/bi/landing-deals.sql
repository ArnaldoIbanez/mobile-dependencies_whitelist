select * from (select todo.site, substr(todo.fecha,1,10), todo.plataforma, todo.deal_id, todo.custid, todo.nickname, case todo.deal_id when 'MLA104' then 'DEAL BEAUTY' when 'MLA108' then 'DEAL GADGETS' when 'MLA119' then 'DEAL ROCKER' when 'MLA90' then 'DEAL TIEMPO LIBRE' when 'MLA89' then 'DEAL PARTY' when 'MLA68' then 'DEAL SPORTY' when 'MLA72' then 'DEAL GEEK' when 'MLA73' then 'DEAL VINTAGE' when 'MLB66' then 'DEAL BEAUTY' when 'MLB67' then 'DEAL GADGETS' when 'MLB68' then 'DEAL ROCKER' when 'MLB65' then 'DEAL TIEMPO LIBRE' when 'MLB64' then 'DEAL PARTY' when 'MLB48' then 'DEAL SPORTY' when 'MLB49' then 'DEAL GEEK' when 'MLB50' then 'DEAL VINTAGE' when 'MLM86' then 'DEAL BEAUTY' when 'MLM88' then 'DEAL GADGETS' when 'MLM95' then 'DEAL ROCKER' when 'MLM79' then 'DEAL TIEMPO LIBRE' when 'MLM78' then 'DEAL PARTY' when 'MLM63' then 'DEAL SPORTY' when 'MLM65' then 'DEAL GEEK' when 'MLM66' then 'DEAL VINTAGE' when 'MLM83' then 'DEAL VIAJES' else todo.deal_id end as deal_name, count(1) as total from (select application.site_id as site, ds as fecha, device.platform as plataforma, v2.deal_id as deal_id, usr.user_id as custid, usr.user_nick as nickname from tracks LATERAL VIEW json_tuple(event_data, 'filters') v1 as filters LATERAL VIEW json_tuple(v1.filters, 'deal') v2 as deal_id where ds >= 'AYER' and ds < 'HOY' and application.site_id IN ('MLA', 'MLB', 'MLM') and application.business = 'mercadolibre' and path = '/search' and device.platform = '/mobile/android')todo group by todo.site, substr(todo.fecha,1,10), todo.plataforma, todo.deal_id, todo.custid, todo.nickname, case todo.deal_id when 'MLA104' then 'DEAL BEAUTY' when 'MLA108' then 'DEAL GADGETS' when 'MLA119' then 'DEAL ROCKER' when 'MLA90' then 'DEAL TIEMPO LIBRE' when 'MLA89' then 'DEAL PARTY' when 'MLA68' then 'DEAL SPORTY' when 'MLA72' then 'DEAL GEEK' when 'MLA73' then 'DEAL VINTAGE' when 'MLB66' then 'DEAL BEAUTY' when 'MLB67' then 'DEAL GADGETS' when 'MLB68' then 'DEAL ROCKER' when 'MLB65' then 'DEAL TIEMPO LIBRE' when 'MLB64' then 'DEAL PARTY' when 'MLB48' then 'DEAL SPORTY' when 'MLB49' then 'DEAL GEEK' when 'MLB50' then 'DEAL VINTAGE' when 'MLM86' then 'DEAL BEAUTY' when 'MLM88' then 'DEAL GADGETS' when 'MLM95' then 'DEAL ROCKER' when 'MLM79' then 'DEAL TIEMPO LIBRE' when 'MLM78' then 'DEAL PARTY' when 'MLM63' then 'DEAL SPORTY' when 'MLM65' then 'DEAL GEEK' when 'MLM66' then 'DEAL VINTAGE' when 'MLM83' then 'DEAL VIAJES' else todo.deal_id end)todo where deal_name like 'DEAL%' and custid is not null order by site, total desc
