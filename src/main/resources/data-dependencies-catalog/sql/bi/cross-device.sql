select todo.fecha, todo.site_id, count(1) from (select todo.fecha, todo.site_id, todo.usrid, todo.query, todo.web_desktop, todo.web_mobile, todo.app_android, todo.app_ios, sum(todo.web_desktop_CONT + todo.web_mobile_CONT + todo.app_android_CONT + todo.app_ios_CONT) as crossDevice from (select substr(ds,1,10) as fecha, application.site_id as site_id, usr.user_id as usrid, v1.query as query, sum(if(device.platform = '/web/desktop',1,0)) as Web_Desktop, sum(if(device.platform = '/web/mobile',1,0)) as Web_Mobile, sum(if(device.platform = '/mobile/android',1,0)) as App_Android, sum(if(device.platform = '/mobile/ios',1,0)) as App_iOS, if(sum(if(device.platform = '/web/desktop',1,0)) >= 1,1,0) as Web_Desktop_CONT, if(sum(if(device.platform = '/web/mobile',1,0)) >= 1,1,0) as Web_Mobile_CONT, if(sum(if(device.platform = '/mobile/android',1,0)) >= 1,1,0) as App_Android_CONT, if(sum(if(device.platform = '/mobile/ios',1,0)) >= 1,1,0) as App_iOS_CONT from tracks LATERAL VIEW json_tuple(event_data, 'query') v1 as query where ds >= 'AYER' and ds < 'HOY' and path like '/search%' and usr.user_id is not null and v1.query is not null group by substr(ds,1,10), application.site_id, usr.user_id, v1.query) todo group by todo.fecha, todo.site_id, todo.usrid, todo.query, todo.web_desktop, todo.web_mobile, todo.app_android, todo.app_ios) todo where todo.crossDevice > 1 group by todo.fecha, todo.site_id
